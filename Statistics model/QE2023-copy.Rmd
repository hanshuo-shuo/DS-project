---
title: "Applied Statistics Qualifying Exam 2023"
date: "2023-09-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lmtest)
library(dplyr)
library(glm2)
library(car)

data <- read.csv("vh_data15.csv")
names(data)

```

# An Overview of the Problem

As a result of public health campaigns, over 70% of individuals in the [United States](https://usafacts.org/visualizations/covid-vaccine-tracker-states/) have been fully vaccinated against COVID-19. Vaccination rates are particularly high for those ages 50 and over. Yet many remain unvaccinated - leading to questions regarding both *why* they are refusing vaccination and how to encourage them to *become* vaccinated. 

## The Data
[Sagir, Mewhirter, and Sanders (2022)](https://www.sciencedirect.com/science/article/pii/S0264410X22001347#s0085) conducted a Qualtrics survey in August 2020 and a followup in March 2022. The final survey includes 3,353 respondents. Each were asked a variety of questions regarding their vaccination status, any hesitancy, their trust in science and vaccines, and other information about themselves and their contexts. They used this information to create a predictive model to help publich health researchers better understand vaccine hesitancy.

All of the information that you need to understand this data is provided. This includes:

 * `vh_data15.csv` : The data
 * `Sagir Mewhirter Sanders 2022.pdf` : The paper and codebook

## This Exam 

The purpose of this exam is to test your ability to put to use all that you have learned in STAT 350, 353, and 415 in the context of real data, with a real question. This involves combining your understanding of regression and machine learning concepts and theory with the implementation of these in code and clear interpretation to a lay audience. Be sure to convey what the results tell you, what assumptions they require, and any limitations in your results. 

For this exam, we will focus in particular on one outcome:

  - `Vaccine_Trust_Index` : an index of the degree to which a respondent trusts vaccines
  
**Finally, a strong exam is one that is judicious in what is presented (you can put materials in an Appendix), that explains the decisions and assumptions that were made and why, that explains the how the results should be interpreted, and that is clear in any limitations.**


## Submission of Report

*  Please complete Part I and Part II together and include your results using one Rmarkdown file. Please submit the .Rmd file and  the generated html or pdf file. 

* For Part III, please use python and include your results in an .ipynb file.

*  Please include your conclusion (i.e., your answer to question 9) in both the .Rmd file and the .ipynb file.


# Part I. Testing Hypotheses

For this part, answer the following questions:

1. What type of regression model will you use for `Vaccine_Trust_Index` (for example, least squares regression)? Explain your choice.  
Before checking that, I check the missing value first. Since the missing value only accounts for a small proportion of data and the distributions of target variable are similar (I check in python files). I simply replace missing value in continuous ones with medians and categorical ones with modes (I revise them with python and just read them here).  
```{r hypothesis1}
data <-  read.csv("vh_data15_revised.csv")
```
```{r hypothesis1}
lm_model <- lm(Vaccine_Trust_Index ~ ., data = data)
plot(lm_model)
shapiro_test <- shapiro.test(lm_model$residuals)
print(shapiro_test)
```
From the plots, I can tell that The fitted results and the residual is not a random located around 0. It seems to be some pattern. Also from QQ plot, the scatter points don't locate along the straight line. It doesn't fit the assumption of linearity and homoscedasticity. Also, I try shapiro test and find very small p-value, which excludes multiple linear regression model. Thus, I try to implement Generalized Linear Model here. After checking the distribution of the outcome variable: Vaccine_Trust_Index.  
```{r hypothesis1}
plot(density(data$Vaccine_Trust_Index), 
     main = "The distribution of Vaccine_Trust_Index",
     xlab = "Vaccine_Trust_Index",
     ylab = "Density",
     col = "blue",
     lwd = 2)
```
I find it's shape of a Gamma distribution. In case of the situation of 0 using gamma in GLR, I replace 0 with 0.0001.  
  
2. Measurement of trust is saved in the variable `Vaccine_Trust_Index`. You suspect that the following variables are associated with this vaccine trust index: `Natural_Science_Literacy`, `Perceived_Risk`, `Perceived_Network_Risk`, `College_Degree`, `Age`, and `Male`.  Please perform an analysis to evaluate these and draw your conclusions. Be sure to interpret your findings.  
```{r}
data$Vaccine_Trust_Index <- ifelse(data$Vaccine_Trust_Index == 0, 0.0001, data$Vaccine_Trust_Index)
```

```{r hypothesis2}
glm_model <- glm(Vaccine_Trust_Index ~ Natural_Science_Literacy + Perceived_Risk + Perceived_Network_Risk + College_Degree + Age + Male,  family = Gamma(link = "log"), data = data)
summary(glm_model)
```
Especially, `College_Degree` and  `Male` are binary categorical variables. According to the summary table, we can tell that holding other variables constant, when the College_Degree is 1, the estimation of Vaccine_Trust_Index would be multiplied by exp(0.111), and when the person is male, the estimation of Vaccine_Trust_Index would be multiplied by exp(0.063). As to the continuous variables, holding other variables constant, one-unit increase in `Natural_Science_Literacy`, `Perceived_Risk`, `Perceived_Network_Risk`, `Age` respectively, will cause the multiplication of exp(0.138), exp(-0.012), exp(0.047), exp(0.001) of Vaccine_Trust_Index respectively. All of the variables mentioned above are of significance. Except for `Perceived_Risk`, the increase of other continuous variables are positively associated with `Vaccine_Trust_Index`. We can also find similar information for people from different education background and gender. It is important for us to understand the influential factors of `Vaccine_Trust_Index`.  


3. To what extent do these effects differ across those that voted for Trump versus those that did not? Interpret your findings.  

```{r hypothesis3}
data_Trump <- data[data$Trump == 'Yes', ]
data_AntiT <- data[data$Trump == 'No', ]
glm_model_Trump <- glm(Vaccine_Trust_Index ~ Natural_Science_Literacy + Perceived_Risk + Perceived_Network_Risk + College_Degree + Age + Male,  family = Gamma(link = "log"), data = data_Trump)
glm_model_AntiT <- glm(Vaccine_Trust_Index ~ Natural_Science_Literacy + Perceived_Risk + Perceived_Network_Risk + College_Degree + Age + Male,  family = Gamma(link = "log"), data = data_AntiT)
summary(glm_model_Trump)
```
```{r}
summary(glm_model_AntiT)
```
It is interesting to find that for those who vote for Trump, `Natural_Science_Literacy` is no longer a significant variable to predict the Trust for the vaccination. `College_Degree` and `Male` are the most important factors to estimate `Vaccine_Trust_Index`. However, for people who does not vote for Trump, `Natural_Science_Literacy` annd `College_Degree` are the most important variables to predict.  

# Part II. Prediction

For this part, answer the following questions. 

4. Please use all available variables that could be used to develop a model to predict vaccine trust (`Vaccine_Trust_Index`). Perform diagnostic analysis and evaluate whether your model is reasonable. Is there any further action you would like to do?  

According to the description of the variables, I prefer to include all the variables but `Race` and `Party_ID`.  
```{r predict1}
data <- subset(data, select = -c(Race, Party_ID))
data$Trump = ifelse(data$Trump == 'Yes', 1, 0 )
data$Biden = ifelse(data$Biden == 'Yes', 1, 0 )
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
data.train <- data[train_index,]
data.test <- data[-train_index,]

glm_model2 <- glm(Vaccine_Trust_Index ~ ., family = Gamma(link = "log"), data = data.train)
```
```{r}
summary(glm_model2)
plot(glm_model2)
```
In residual plots, the pattern is not obvious as previous shown, which means this model is better. However, the signal of curvature may explain the non-linearity or the out-liers. However, according to the p-values, there are many non-significant variables. If we can further select the variables, the result in QQ plot and residual plots will be better.  
```{r}
predicted_values <- predict(glm_model2, newdata = data.test, type = "response")
residuals <- data.test$Vaccine_Trust_Index - predicted_values
mse <- mean(residuals^2)
rmse <- sqrt(mse)
rmse
```
In summary, the model appears to be reasonable based on the goodness-of-fit measures and the significance of various predictors, but still need further selection of the varaibles. 

5. Develop and implement an approach to build the best model possible that predicts vaccine trust. What is your final model and why is the best? Be sure to clearly explain your approach in language a non-statistician could understand.  

I decide to use stepwise to do variable selection.  
```{r predict2, echo = False, eval = False, result = False,include = TRUE}}
final_model <- step(glm_model2, direction = "both")
```
```{r}
summary(final_model)
```
```{r}
summary(final_model)
```

```{r}
predicted_values <- predict(final_model, newdata = data.test, type = "response")
residuals <- data.test$Vaccine_Trust_Index - predicted_values
mse <- mean(residuals^2)
rmse <- sqrt(mse)
rmse
```

We iterate from both sides by adding and removing variables to select variables according to AIC values. For the final model, we have smaller AIC value and more significant varaibles. Though the number of variables reduces, rmse value goes smaller. We get a better model.


9. Putting together what you have learned in this exam and the findings from the Sanger et. al study, what are your conclusions? How could this data and analysis be used to guide health care policy and practice? Be sure to include any limitations.  


